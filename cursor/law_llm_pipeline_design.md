# 법령정보 전체 수집 · 렌더링 · 색인 설계 문서 (LLM 서비스용)

## 0. 문서 목적
이 문서는 **LLM 서비스에서 법령 질문에 정확히 답변하기 위한 컨텍스트 확보**를 목표로,
국가법령정보센터 법령 데이터를 **전체 수집 → 렌더링 HTML 정규화 → 조/항 단위 색인 → 연계법령 확장**까지
일관된 파이프라인으로 구축하기 위한 작업 정의 문서다.

본 문서는 **Cursor에게 작업 맥락을 이해시키고, 코드 작성/확장을 지시하기 위한 기준 문서**로도 사용한다.

---

## 1. 전체 목표 (LLM 관점)
- LLM은 법령 질문에 대해 **충분한 컨텍스트**가 있을 때 정확한 답변 가능
- 단일 법령 본문만으로는 부족하며, 다음이 필요:
  - 법령 전체 본문
  - 조(또는 항) 단위의 세밀한 색인
  - 해당 조문이 **연계/참조/위임**하는 다른 법령 정보
- 검색을 여러 번 수행하는 **에이전틱 검색 구조**에서도
  연계된 법령을 빠짐없이 확장할 수 있도록 설계

---

## 2. 현재 데이터베이스 상태

### DB: `law_info`

#### 2.1 `law_list` (법령 목록 / 메타 테이블)
- 법령 고유 ID (PK)
- 법령명(한글), 약칭
- 소관부처, 법령 구분
- 공포일자, 공포번호
- 시행일자
- 법령 상세 링크
- 수집 상태/삭제 여부
- 생성·수정 일시

👉 **법령 단위 메타 정보 저장용**

---

#### 2.2 `law_detail` (법령 상세 원천 테이블)
- `law_id` (FK)
- `json` : 국가법령정보 API 응답 원문(JSON)
- `xml`  : 국가법령정보 API 응답 원문(XML)
- `html` : 국가법령정보 API 응답 HTML (※ 렌더링 전 상태)
- 수집 모드, 삭제 여부, 생성·수정 일시

👉 현재 `html` 컬럼의 HTML은 **진짜 본문 DOM이 아님**
(iframe + JS 기반 렌더링 구조)

---

## 3. 문제 정의: “진짜 HTML”이 필요한 이유
- 법령정보센터 웹 페이지는 다음 구조를 가짐:

```
법령 HTML(API)
 → iframe (lsInfoP.do)
   → 내부 JS 실행
     → lsInfoR.do (POST) 응답을 DOM에 삽입
```

- `law_detail.html`에 저장된 HTML은 **중간 래퍼**
- 연계법령(관련/참조 법령)은 **최종 렌더링 결과 DOM**에만 존재
- 따라서 연계법령 파싱을 위해서는:
  👉 **렌더링 완료 상태에 준하는 HTML을 직접 생성·저장해야 함**

---

## 4. 작업을 2파트로 분리하는 이유
- 렌더링/수집 정규화와
- 조/항 단위 색인 + 연계법령 결합은
  **관심사와 변경 주기가 다름**

따라서 다음과 같이 2파트로 분리한다.

---

# Part 1. “진짜 HTML” 렌더링 및 DB 저장

## 4.1 목적
- 모든 법령에 대해 **렌더링 완료 상태의 HTML을 안정적으로 확보**
- 이후 파싱/색인 단계에서 HTML 구조 차이로 인한 오류 제거

---

## 4.2 Part 1-1: lsiSeq 확보 및 저장
- `lsInfoR.do` 호출을 위해서는 `lsiSeq`가 필수
- `law_detail.html` 또는 iframe src에서 `lsiSeq` 추출
- 법령별로 `law_id ↔ lsiSeq` 매핑 저장

👉 이후 대량 수집 시 iframe 단계를 생략 가능

---

## 4.3 Part 1-2: 렌더링 HTML 생성
- 절차:
  1. iframe src (`lsInfoP.do`) GET
  2. 내부 JS 파라미터(`lsPopViewAll2`) 추출
  3. `lsInfoR.do` POST 호출
  4. 응답 HTML(body) 수신
  5. 필요 시 원본 HTML + body 병합 → `html_full` 생성

---

## 4.4 신규 테이블 제안: `law_rendered`
렌더링 결과 전용 테이블

- `law_id`
- `lsi_seq`
- iframe_src
- lsInfoR_params (jsonb)
- html_body
- html_full
- status_code
- fetch_error
- fetched_at / updated_at

👉 **Part 2의 입력 소스**

---

# Part 2. 조/항 단위 색인 + 연계법령 결합

## 5.1 목적
- 검색엔진에 투입할 **최종 색인 문서 생성**
- LLM이 사용할 컨텍스트 단위 정의

---

## 5.2 Part 2-1: 조/항 단위 분해
- 소스:
  - `law_detail.xml` 또는 `json` (구조적, 신뢰도 높음)
- 처리:
  - 조 / 항 / 호 단위로 분해
  - 조문번호, 본문 텍스트, 시행일/공포일 등 메타 포함

---

## 5.3 Part 2-2: 연계법령 파싱 및 결합
- 소스:
  - `law_rendered.html_full`
- 처리:
  - “연계법령 / 관련법령 / 참고법령” 영역 파싱
  - 연계된 법령의:
    - 법령명
    - 법령 ID(또는 링크)
    - 연계 유형(참조/위임/관련)
  - 조문 단위 문서에 함께 포함

---

## 6. 검색엔진 색인 단위(예시)
- `law_id`
- `law_name`
- `article_no` (조/항)
- `text`
- `effective_date`
- `promulgation_date`
- `linked_laws: [{ law_id, title, type }]`

👉 에이전트가 연계법령을 다시 검색하는 힌트로 사용

---

## 7. 전체 파이프라인 요약
```
law_list / law_detail
  → (Part 1) lsiSeq 매핑 + rendered HTML 생성
    → law_rendered
      → (Part 2) 조/항 분해 + 연계법령 결합
        → 검색엔진 색인
          → LLM 에이전틱 컨텍스트 확장
```

---

## 8. 설계 원칙
- 렌더링 로직과 색인 로직 분리
- HTML은 “한 번만 정확히” 생성
- 색인은 언제든 재생성 가능하도록 설계
- LLM은 직접 추론하지 않고 **충분한 컨텍스트를 제공받는 역할**

---

## 9. Cursor 작업 시 유의사항
- iframe 구조/JS 로직은 **렌더링 파트(Part 1)에만 존재**
- 색인 파트(Part 2)는 HTML 구조 변경에 영향받지 않도록 분리
- 모든 단계는 대량 수집을 전제로 작성
